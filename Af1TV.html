<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AF1CIONADOS TV</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#000;color:white;display:flex;flex-direction:column;height:100vh;overflow:hidden}
    header{background:#111;padding:8px 12px;display:flex;align-items:center;gap:10px;border-bottom:2px solid #ff4500}
    header img{width:42px;height:42px;border-radius:50%;border:2px solid #ff4500}
    header h1{font-size:19px;font-weight:bold}

    /* REPRODUCTOR MÁS PEQUEÑO */
    #player{background:black;position:relative;overflow:hidden;cursor:pointer;flex:0 0 22vh}
    @media (orientation: landscape){#player{flex:0 0 16vh}}
    #video,#audio{width:100%;height:100%;object-fit:contain;background:black}
    #radioPlaceholder{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:110px;height:110px;background:url('https://i.postimg.cc/P5CL0ncC/logo11-17-205545.png') center/contain no-repeat;display:none;z-index:10}

    #searchInput{background:#222;color:white;border:none;padding:10px;margin:6px;border-radius:8px;width:calc(100%-12px);font-size:15px}
    .tabs{display:flex;gap:6px;padding:4px 6px;overflow-x:auto;background:#111;scrollbar-width:none}
    .tabs::-webkit-scrollbar{display:none}
    .tab{background:#222;padding:9px 16px;border-radius:8px;min-width:85px;text-align:center;cursor:pointer;font-size:13.5px;transition:.2s}
    .tab:hover{background:#333}
    .tab.active{background:#ff4500;font-weight:bold;color:white}

    .channelList{flex:1;overflow-y:auto;padding:8px 10px;background:#000}
    .channel{display:flex;align-items:center;gap:14px;padding:13px;background:#111;border-radius:12px;margin:5px 3px;cursor:pointer;transition:.2s;border:1px solid #1a1a1a}
    .channel:hover{background:#1f1f1f;border-color:#ff4500}
    .channel.selected{background:#ff4500;color:white;font-weight:bold}
    .channel img{width:38px;height:38px;border-radius:50%;object-fit:cover;flex-shrink:0}
    .channel span{flex:1;font-size:15px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .loading{text-align:center;padding:60px;color:#666;font-size:17px}
    #channelOverlay{position:absolute;bottom:10px;left:10px;background:rgba(0,0,0,0.85);padding:9px 16px;border-radius:10px;font-weight:bold;z-index:10;display:none;font-size:15px}
  </style>
</head>
<body>

<header>
  <img src="https://i.postimg.cc/P5CL0ncC/logo11-17-205545.png" alt="Logo">
  <h1>AF1CIONADOS TV</h1>
</header>

<!-- DOBLE CLIC = PANTALLA COMPLETA -->
<div id="player" ondblclick="document.fullscreenElement?document.exitFullscreen():this.requestFullscreen()">
  <video id="video" preload="none" playsinline></video>
  <audio id="audio" preload="none" playsinline></audio>
  <div id="radioPlaceholder"></div>
  <div id="channelOverlay"></div>
</div>

<input type="text" id="searchInput" placeholder="Buscar canal...">

<div class="tabs">
  <div class="tab active" data-type="all">Todos</div>
  <div class="tab" data-type="country">Países</div>
  <div class="tab" data-type="category">Categorías</div>
  <div class="tab" data-type="radio">Radios</div>
</div>

<div class="channelList" id="channelList"></div>

<script>
  const video = document.getElementById('video');
  const audio = document.getElementById('audio');
  const radioPlaceholder = document.getElementById('radioPlaceholder');
  const searchInput = document.getElementById('searchInput');
  const tabs = document.querySelectorAll('.tab');
  const channelList = document.getElementById('channelList');
  const overlay = document.getElementById('channelOverlay');
  let allChannels = [];
  let currentHls = null;
  let currentDash = null;
  let currentMode = 'tv';
  const LOGO = 'https://i.postimg.cc/P5CL0ncC/logo11-17-205545.png';
  const cacheKey = 'af1_channels_cache';
  const cache = JSON.parse(localStorage.getItem(cacheKey) || '{}');

  video.style.display = 'none';
  audio.style.display = 'none';
  radioPlaceholder.style.display = 'block';

  loadAllChannels();

  searchInput.addEventListener('input', function () {
    const filtered = allChannels.filter(c => c.name.toLowerCase().includes(this.value.toLowerCase()));
    displayChannels(filtered, currentMode === 'radio');
  });

  tabs.forEach(tab => {
    tab.addEventListener('click', function () {
      tabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      const type = this.getAttribute('data-type');
      currentMode = type === 'radio' ? 'radio' : 'tv';
      if (type === 'all') loadAllChannels();
      else if (type === 'country') loadChannelsByType('country');
      else if (type === 'category') loadChannelsByType('category');
      else if (type === 'radio') loadRadioCountries();
    });
  });

  function loadAllChannels() {
    const url = 'https://iptv-org.github.io/iptv/index.m3u';
    if (cache[url]) { allChannels = cache[url]; displayChannels(allChannels, false); return; }
    loadRemoteList(url);
  }

  function loadChannelsByType(type) {
    const channelsByType = {
      country: [
        { name: 'España TVGarden', url: 'https://raw.githubusercontent.com/TVGarden/tv-garden-channel-list/main/channels/raw/countries/es.json', logo: LOGO },
        { name: 'España IPTV-Org', url: 'https://iptv-org.github.io/iptv/countries/es.m3u', logo: LOGO },
        { name: 'México', url: 'https://iptv-org.github.io/iptv/countries/mx.m3u', logo: LOGO },
        { name: 'Argentina', url: 'https://iptv-org.github.io/iptv/countries/ar.m3u', logo: LOGO },
        { name: 'USA', url: 'https://iptv-org.github.io/iptv/countries/us.m3u', logo: LOGO }
      ],
      category: [
        { name: 'Futbol', url: 'https://raw.githubusercontent.com/la22lo/sports/main/futbol.m3u', logo: LOGO },
        { name: 'Deportes', url: 'https://iptv-org.github.io/iptv/categories/sports.m3u', logo: LOGO },
        { name: 'Películas', url: 'https://iptv-org.github.io/iptv/categories/movies.m3u', logo: LOGO },
        { name: 'Noticias', url: 'https://iptv-org.github.io/iptv/categories/news.m3u', logo: LOGO },
        { name: 'Infantiles', url: 'https://iptv-org.github.io/iptv/categories/kids.m3u', logo: LOGO }
      ]
    };
    const channels = channelsByType[type];
    channelList.innerHTML = '';
    channels.forEach(channel => {
      const div = document.createElement('div');
      div.className = 'channel';
      div.innerHTML = `<img src="${channel.logo}" onerror="this.src='${LOGO}'"><span>${channel.name}</span>`;
      div.onclick = () => loadRemoteList(channel.url);
      channelList.appendChild(div);
    });
  }

  // TU PARSER ORIGINAL 100% INTACTO (carga perfecto siempre)
  function loadRemoteList(url) {
    const cacheUrl = url;
    if (cache[cacheUrl]) {
      allChannels = cache[cacheUrl];
      displayChannels(allChannels, currentMode === 'radio');
      return;
    }

    channelList.innerHTML = '<div class="loading">Cargando...</div>';
    fetch(url)
      .then(response => {
        const contentType = response.headers.get('content-type') || '';
        if (contentType.includes('application/json') || url.endsWith('.json')) {
          return response.json();
        } else {
          return response.text().then(text => parseM3U(text));
        }
      })
      .then(data => {
        if (!Array.isArray(data)) {
          let channelsData = [];
          if (data.channels && Array.isArray(data.channels)) {
            channelsData = data.channels;
          } else if (data.countries) {
            data.countries.forEach(country => {
              country.ambits.forEach(ambit => {
                channelsData = channelsData.concat(ambit.channels);
              });
            });
          }
          data = channelsData;
        }
        allChannels = data.map(channel => ({
          name: channel.name,
          url: channel.options ? channel.options[0].url : channel.iptv_urls ? channel.iptv_urls[0] : channel.url || 'No disponible',
          logo: channel.logo || LOGO
        })).filter(channel => channel.url !== 'No disponible');
        cache[cacheUrl] = allChannels;
        localStorage.setItem(cacheKey, JSON.stringify(cache));
        displayChannels(allChannels, currentMode === 'radio');
      })
      .catch(error => {
        channelList.innerHTML = '<div class="loading">Error al cargar</div>';
      });
  }

  function parseM3U(content) {
    const channels = [];
    const lines = content.split('\n');
    let infoLine = null;
    for (let line of lines) {
      line = line.trim();
      if (line.startsWith('#EXTINF:')) {
        infoLine = line;
      } else if (line && !line.startsWith('#')) {
        if (infoLine) {
          const channel = parseInfoLine(infoLine, line);
          channels.push(channel);
        }
        infoLine = null;
      }
    }
    return channels;
  }

  function parseInfoLine(infoLine, url) {
    const channel = { url };
    const match = infoLine.match(/#EXTINF:[-0-9.]+(.*),(.*)/);
    if (match) {
      const attrs = match[1].trim();
      channel.name = match[2].trim();
      const attrPairs = attrs.match(/([a-z\-]+)="([^"]*)"/g) || [];
      attrPairs.forEach(pair => {
        const [key, value] = pair.split('=');
        const cleanKey = key.trim().toLowerCase();
        const cleanValue = value.replace(/"/g, '').trim();
        if (cleanKey === 'tvg-logo' || cleanKey === 'logo') {
          channel.logo = cleanValue;
        }
      });
    } else {
      channel.name = 'Unknown';
    }
    if (!channel.logo) channel.logo = LOGO;
    return channel;
  }

  function displayChannels(channels, isRadio = false) {
    channelList.innerHTML = '';
    if (channels.length === 0) {
      channelList.innerHTML = '<div class="loading">No se encontraron canales</div>';
      return;
    }
    channels.forEach((channel, index) => {
      const div = document.createElement('div');
      div.className = 'channel';
      div.innerHTML = `<img src="${channel.logo}" onerror="this.src='${LOGO}'"><span>${channel.name}</span>`;
      div.onclick = () => {
        document.querySelectorAll('.channel').forEach(c => c.classList.remove('selected'));
        div.classList.add('selected');
        playChannel(channel.url, channel.name, isRadio);
      };
      channelList.appendChild(div);
    });
  }

  function playChannel(url, name, isRadio = false) {
    if (currentHls) { currentHls.destroy(); currentHls = null; }
    if (currentDash) { currentDash.destroy(); currentDash = null; }

    if (isRadio) {
      video.style.display = 'none';
      audio.style.display = 'block';
      radioPlaceholder.style.display = 'block';
      video.pause(); video.src = ''; video.removeAttribute('controls');
      audio.controls = false;   // ← AQUÍ ESTÁ LA CLAVE: NUNCA sale la barra blanca
    } else {
      video.style.display = 'block';
      audio.style.display = 'none';
      radioPlaceholder.style.display = 'none';
      audio.pause(); audio.src = '';
      video.controls = true;
    }

    if (url.includes('.mpd')) {
      currentDash = dashjs.MediaPlayer().create();
      currentDash.initialize(isRadio ? audio : video, url, true);
    } else if ((url.includes('.m3u8')||url.includes('.m3u')) && Hls.isSupported()) {
      currentHls = new Hls({lowLatencyMode:true});
      currentHls.loadSource(url);
      currentHls.attachMedia(isRadio ? audio : video);
    } else {
      (isRadio ? audio : video).src = url;
    }
    (isRadio ? audio : video).play().catch(()=>{});

    overlay.textContent = isRadio ? 'Escuchando: ' + name : 'Viendo: ' + name;
    overlay.style.display = 'block';
    setTimeout(() => overlay.style.display = 'none', 10000);
  }

  // Resto del código de radios exactamente como lo tenías (funciona perfecto)
  function loadRadioCountries() {
    fetch('https://de1.api.radio-browser.info/json/countries?order=stationcount&reverse=true&hidebroken=true')
      .then(r=>r.json())
      .then(d=> { channelList.innerHTML=''; d.slice(0,50).forEach(c=> {
        const div=document.createElement('div'); div.className='channel';
        const flag=c.iso_3166_1?`https://flagcdn.com/32x24/${c.iso_3166_1.toLowerCase()}.png`:LOGO;
        div.innerHTML=`<img src="${flag}"><span>${c.name} (${c.stationcount})</span>`;
        div.onclick=()=>loadRadioStations(c.name);
        channelList.appendChild(div);
      });});
  }

  function loadRadioStations(country) {
    fetch(`https://de1.api.radio-browser.info/json/stations/bycountryexact/${encodeURIComponent(country)}?hidebroken=true&limit=1000&order=clickcount&reverse=true`)
      .then(r=>r.json())
      .then(st=>displayChannels(st.filter(s=>s.url_resolved).map(s=>({name:s.name,url:s.url_resolved,logo:s.favicon||LOGO})), true));
  }
</script>
</body>
</html>
